= Tutorial: Object Store v2
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

Use this tutorial to get started with using Object Store v2 to store and view data.

In this tutorial, you:


. Create an app in Design Center, configure Anypoint Object Store Connector, and test the connection.
. Create an app in Anypoint Studio, configure Anypoint Object Store Connector, and test the connection.
+
Depending on your Mule version, you create your app in Studio 7 (Mule 4) or Studio 6 (Mule 3).



== Prerequisites

* Familiarity with Anypoint Studio, Anypoint Platform, and Runtime Manager
* An xref::anypoint.mulesoft.com[Anypoint Platform account]
* A Design environment configured in Anypoint Platform *Access Management > Environments*.
+
If you don't see *Access Management*, contact your site administrator.
* An Enterprise license
+
Contact the MuleSoft Sales team to get a free trial.
* Anypoint Studio installed on your system
* A https://curl.haxx.se[`curl`] command for testing 
+
Alternatively, you can use Postman or browser plugins.

This tutorial uses the HTTP Listener trigger to initiate Anypoint MQ Connector access and a `curl` command to submit REST API commands to the Anypoint MQ Broker API.



== Create and Configure Object Store in a Mule App in Design Center

You use Design Center to configure an app that includes an HTTP Listener trigger and an Object Store Connector.
Then, you can use a `curl` command to send a key and value, and view the key in Runtime Manager.


=== Prerequisites

Disable password programs such as LastPass or Okta in your browser before using Design Center.
If enabled, the password program inserts passwords in fields in Design Center, which can cause the app to fail. 

=== Configure an App with Object Store in Design Center

To configure an app in Design Center:

. In *Anypoint Platform*, click *Design Center* in the left navigation bar or the main Anypoint Platform screen.
. Click the *Create new* button to create a new project.
+
In the create window, select *Create new application*:
+
.The arrow shows the *Create new application* option.
image::os-tutorial-dc-create-app.png[Create new application option]
+
. In the *New Mule Application* window, enter `osv2demo` for the project name and click *Create*.
. In the wizard, click *Go straight to canvas*:
+
.The arrow shows the *Go straight to canvas* option.
image::os-tutorial-dc-goto-canvas.png[Go straight to canvas]
+
. Click the *Trigger* box and enter `H` to search for the HTTP Listener:
+
.The arrow shows the HTTP Listener.  
image::os-tutorial-dc-http-search.png[Search for the HTTP Listener]
+
. Click *HTTP Listener*.
. In the HTTP Listener window, set the value of *Path* to `/store` and then click the *Close* button (X):
+
.The screenshot shows (*1*) the *Path* value and (*2*) the *Close* button (X).
image::os-tutorial-dc-http-path.png[Path value and Close button]
+
. Click the plus icon (+) to the right of the HTTP Listener trigger:
+
.The arrow shows the plus icon (+).
image::os-tutorial-dc-plus-icon.png[Plus icon]
+
. In the *Select a component* window, enter `obj` to search for the ObjectStore Connector:
+
.The arrow shows the ObjectStore Connector.
image::os-tutorial-dc-os-search.png[Search for the Object Store Connector]
+
. Click the connector, then click the *Store* operation:
+
.The arrow shows the *Store* operation.
image::os-tutorial-dc-store-select.png[Store operation]
. In the *Configuration* tab, specify `#[payload.key]` in the *Key* field and `payload.value` in the *Value* field:
+
.The screenshot shows (*1*) the *Key* field and (*2*) the *Value* field.
image::os-tutorial-dc-store-values.png[Key and Value fields for the Store operation]
. Click *Test* to run the app in a temporary location.


+
The app starts running in a temporary environment.
+
.The arrow shows a message indicating the `osv2demo` app is running in a temporary environment.
image::os-tutorial-dc-running.png[The osv2demo app running in a temporary environment]
. Click *Stop test*.
. Select *Deploy application* from the menu to the right of the *Test* button:
+
.The arrow shows the *Deploy application* menu option in Design Center.
image::os-tutorial-dc-deploy-option.png[Deploy application menu option]
. Select the target environment and the name you want to use for the application in CloudHub.
+
A message indicates when the deployment is successful. 
. Click *Show more* and then click *here* to view the app in Runtime Manager.
. Click *Settings*.

You have successfully used Design Center to configure an app with an object store and deploy it to CloudHub.

Next, you test the connection by submitting REST API commands to the Object Store API and using Runtime Manager to view the results.

=== Test Your Design Center App

After you create your app in Design Center, you test your app using a `curl` command to submit a REST API command to the Object Store API and use Runtime Manager to view the results.

To test your app:

. In the *Settings* page, copy the *App url*.
+
.The arrow shows the *App url* in the details pane for your app in the *Settings* page in Runtime Manager.
image::os-tutorial-rtm-deploy-url.png[App URL in the Settings page in Runtime Manager]
. Run the following `curl` command from a command prompt to send the key-value pair. 
+
Replace _APP-URL_ with the deployment URL from Runtime Manager. 
+
[source,json,linenums]
----

curl -X POST \
  "http://APP-URL/store"
  -H "Content-Type: application/json" 
  -d '{ "key": "myKey", "value": "OSv2 Test" }' 

----
+
The output is an echo:

+
[source,console]
----
{ "key": "myKey", "value": "OSv2 Test" }
----

. In *Runtime Manager*, click *Object Store* in the left navigation pane.
. Click the object store, the partition, and then the key.
You can see the value is `[binary value] BINARY`.

`myKey` is in the Object Store user interface, which confirms that the key can be sent through your Design Center application and stored in the Object Store.

The value is binary because Mule 4 wraps values in a Mule object that causes
them to be only visible in binary through Anypoint Platform. Behind the scenes, Mule 4
executes binary serialization with the Mule internal serializer. The user interface cannot
deserialize the object, hence it can only tell you that the value is now binary in the user
interface.

To verify that your value worked too, return to Design Center and add a new flow that retrieves a value.


You have successfully tested your app using a `curl` command to submit a REST API command to the Anypoint MQ Broker API and using Anypoint MQ to view the results. Next, you create a Mule app in Anypoint Studio 7 and connect it to Anypoint MQ.



This completes creating the first part of your application. Leave your Design Center application running for the next task where we test the application. Even if the Design Center window times
out, the application stays running while you are logged on. Click the application in the *Projects*
screen and look for *Status Running*.



=== Retrieve the Value

. Click the menu icon and click *Design Center*.
. In Design Center, click your project, and click *Open*.
. Open the rectangular box icon to the left of Project to expand the *Flow* menu.
. First rename your existing flow by clicking the vertical dot icon and clicking *Rename* from
the menu. Change `New Flow` to `Store`.
+
image::os-dc-flows.png[]
+
. Click the plus sign to the right of *Flows*.
. Click *Go straight to canvas* to exit the wizard.
. In the Trigger menu, choose *HTTP Listener*.
. For *Path*, specify the `/retrieve` value.
+
image:os-dc-http-retrieve.png[]
+
Because the default settings for the HTTP Listener are correct, there's no need to click Edit.
However you can verify that *Host* is `0.0.0.0` and *Port* is `8081`. These values
are the same as in the previous `Store` flow.
+
. Now that we have started the flow, rename it to `Retrieve`.
. Click the plus sign next to the HTTP Listener to add a component.
. In *Select a component*, search for `Obj`, and click the *ObjectStore Connector*.
. Click the *Retrieve* operation and in the *Key* field, specify the `#[attributes.queryParams.key]` value.

This completes the *Retrieve* flow. Click *Run* again to restart your application.

In the command prompt, submit a curl command to view the key's value:

[source,console]
----
curl http://LINK_FROM_DESIGN_CENTER/retrieve?key=MyKey;echo
----

Replace `LINK_FROM_DESIGN_CENTER` with the cloudhub.io link in Design Center.

(The `;echo` statement at the end of the command makes the output more readable.)

The output from this command lists the value for the key:

[source,console]
----
"OSv2 Test"
----

This exercise shows that the object store you create in Design Center can be accessed using a curl command, and
the key becomes visible in Runtime Manager.

You don't need to view the Runtime Manager interface each time you update an object store. After you create an application linked to the Object Store v2 connector, you can
store a key and value in the Object Store with one curl command and view the results with another. Just change the key and/or the value as needed.

Store:

[source,console]
----
curl -X POST -H "Content-Type: application/json" -d '{ "key": "MyKey", "value": "OSv2 Test" }' "http://LINK_FROM_DESIGN_CENTER/store"
----

Retrieve:

[source,console]
----
curl http://LINK_FROM_DESIGN_CENTER/retrieve?key=MyKey
----

In each command, replace `LINK_FROM_DESIGN_CENTER` with the cloudhub.io link in Design Center.

For more information on moving to programmatic access of Object Store, see
https://anypoint.mulesoft.com/exchange/portals/anypoint-platform/f1e97bc6-315a-4490-82a7-23abe036327a.anypoint-platform/object-store-v2/[Object Store v2 API].
Programmatic conventions that worked with Object Store v1 also work with Object Store v2.

== Create a Studio 7 Project

. In Anypoint Studio, click *File > New > Mule Project* and give the project a name such as `osv2`.
. Click the Exchange X icon in the upper left of the Studio task bar.
. In the Exchange window, click *Login* and provide your Anypoint Platform user name and password.
. Search for the ObjectStore Connector for Mule 4. You can enter a substring such as "obj" and
Exchange finds the right asset for you.
. Click the ObjectStore Connector for Mule 4 Exchange asset, and click *Add to project* in the upper right. Click *Proceed* at the verification prompt.
. In the Studio Mule Palette, click HTTP. Click *Listener* and drag it to the canvas.
+
image::os-as-drag-listener.png[]
+
. Click the green plus sign to the right of the *Connector configuration* field and set
the Host to 0.0.0.0 and the Port to 8081.
+
image::os-as-http-listener-config.png[]
+
. In the connector's main screen, set *Path* to `/store`.
+
image::os-as-http-path.png[]
+
. Click *ObjectStore* in the Mule Palette and drag the *Store* operation to the canvas.
. Specify the Key as `#[payload.key]` and the Value with the `payload.value` string.
. Click the green plus sign to the right of the Object Store field, and in the Global
Element Properties screen, click OK to accept the defaults.
. Click the HTTP Listener again and drag it to the canvas under the first flow to create a second
flow. Use the same settings as in Step 7. In the main screen, set *Path* to `retrieve`.
+
image::os-as-2nd-flow-http.png[]
+
. Click ObjectStore in the Mule Palette and drag the *Retrieve* operation to the canvas.
. Set the *Key* field to `#[attributes.queryParams.key]`.
. Click the green plus sign to the right of the *Object Store* field, and in the *Global
Element Properties* screen, click *OK* to accept the defaults.
. You can change a flow label by double-clicking it. Change the first flow to
`Store` and the second flow to `Retrieve`.
+
When done, the flows should appear as:
+
image::os-as-finished-flows.png[]

You now have a completed Studio application. You can test that it runs correctly by
clicking *Run As > Mule Application*. This is just a test. Once you get your application
to run, you can stop it.

=== Test Your Studio 7 Application

. In Studio, right click your project in the Package Explorer.
. Click *Anypoint Platform* > *Deploy to CloudHub*. Note: CloudHub is name of the server, but
you access your application in Anypoint Platform *Runtime Manager*.
+
image::os-as-deploy-to-cloudhub.png[]
+
. After your application appears in Anypoint Platform *Runtime Manager*, start it so that
the application is running. Note the cloudhub.io URL.
. From the command line, enter this curl command:
+
[source,console]
----
$ curl -X POST -H "Content-Type: application/json" -d '{ "key": "MyKey", "value": "OSv2 Test" }' "http://LINK_FROM_RUNTIME_MANAGER/store"
----
+
Replace `LINK_FROM_RUNTIME_MANAGER` with the cloudhub.io URL for your application in Runtime Manager.
+
You can improve readability for this command if you append `;echo` to the end of the command.
+
. In Runtime Manager, click *CloudHub* in the *Server* column for your application to display details, and click *Manage Application*.
+
image::os-rm-manage-app.png[]
+
. Click *Object Store* and choose the object store, the partition, and key you wish to view. You can
see the value as `[binary value] BINARY`.
+
You can see that `MyKey` made it into the Object Store v2 user interface, confirming that keys can be sent through your Studio 7 application and stored in the Object Store.
+
. To view the value for the key, use this curl command:
+
[source,console]
----
curl http://LINK_FROM_RUNTIME_MANAGER/retrieve?key=MyKey
----
+
The output from this command lists the value for the key:
+
[source,console]
----
"OSv2 Test"
----

This concludes the Studio 7 exercise. The gist of this lesson is that you can create Object
Store flows in Studio, use the curl command to store key/value pairs in the Object Store, and view the results in Runtime Manager. An additional curl command lets you see the value for a key.

=== Studio 7 XML

The XML for the Studio application is as follows. This information lets you see how Studio
identifies the HTTP Listener and Object Store connector in XML. You can also use this to
check your flow if your Studio project doesn't work as expected. (Your project's XML file
contains doc ID statements, which are not listed here to improve readability.)

[source,console,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core
	http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core
http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/os
http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<http:listener-config name="HTTP_Listener_config"
		doc:name="HTTP Listener config">
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<os:object-store name="Object_store" doc:name="Object store" />
	<http:listener-config name="HTTP_Listener_config1"
		doc:name="HTTP Listener config">
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<os:object-store name="Object_store1" doc:name="Object store" />
	<flow name="Store" >
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config"
			path="/store">
			<ee:repeatable-file-store-stream />
		</http:listener>
		<os:store doc:name="Store"
			key="#[payload.key]"
			objectStore="Object_store">
			<os:value ><![CDATA[payload.value]]></os:value>
		</os:store>
	</flow>
	<flow name="Retrieve" >
		<http:listener doc:name="Listener" config-ref="HTTP_Listener_config1"
			path="/retrieve">
			<ee:repeatable-file-store-stream />
		</http:listener>
		<os:retrieve doc:name="Retrieve"
			key="#[attributes.queryParams.key]"
			objectStore="Object_store1"/>
	</flow>
</mule>
----

== Create a Studio 6 Project

If you are only working in Anypoint Studio 7, skip this section.

. To create a new project, open Anypoint Studio and click *File > New > Mule Project*. In this tutorial, the project name is `objstoredemo`.
. Create an application like this:
+
image::osv2-studio-flow.png[]
+
. Search for `http` and drag and drop the HTTP connector onto the Studio Canvas. The HTTP connector listens for the curl command we use to store a key and value in Object Store.
+
Click the green plus to the right of *Connector Configuration* and in the *Global Element Properties* screen, accpet the default settings (*Host* `0.0.0.0` and *Port* `8081`), and click *OK*:
+
image::osv2-http-config.png[]
+
. In the HTTP properties screen, set *Path* to `/store` and *Allowed Methods* to `POST`:
+
image::osv2-http-properties.png[]
+
When you submit a curl command, use the `/store` option in the URL,
for example, `objstoredemo.cloudhub.io/store`. The *Allowed Methods* setting ensures that those who use the curl command can POST information only to an object store.
+
. Locate and add the *Object to String* component to the Studio canvas. No settings are necessary -- this component converts the content received from the HTTP connector into a string.
. Locate and add the *JSON to Object* component. Set the *Return Class* to `java.util.Map`:
+
image::osv2-json-to-object.png[]
+
. Search for `objectstore` and add the Object Store connector. If there is no Object Store connector,
install it as described in <<Install the Object Store Connector>>.
. Click the green plus sign to the right of *Connector Configuration* and in the *Global Element Properties* screen,
assign a *Partition* name such as `mypartition`.
Set the Object Store Reference field to `_defaultUserObjectStore`.
+
*Note:* The *Object Store Reference* field must be set to `_defaultUserObjectStore` for data to be stored in Object Store v2:
+
image::os-studio-gep-settings.png[Studio Global Element Property settings]
+
Leave the remaining settings blank, and click *OK*.
+
. Set the *Operation* to *Store* and set these *Store operation* values:
+
	* Set *Key* to `#[payload.key]`
	* Set *Value Reference* to `#[payload.value]`
+
image::osv2-connector.png[]
+
. Locate and add *Set Payload*. Set the *Value* field to `KEY: #[payload.key] AND VALUE: #[payload.value] WERE SAVED OK` - this message displays on the command line to let you know the curl command values are received by the application.
+
image::osv2-set-payload.png[]
+
. Save the application and click *Run > Run As > Mule Application*. Running the application ensures your application works correctly. If you need to fix anything, do so now. After your application runs correctly, you can stop your application.

=== To Deploy Your Application in Anypoint Platform

. In Studio, right-click your application's name in Package Explorer and click *Anypoint Platform > Deploy to Cloud*.
. In the user login window, specify your Anypoint Platform username and password, and click *Sign in*. If you don't have an Anypoint Platform login, click *Sign up*.
. In Runtime Manager, specify an application name. Each name is unique and becomes the URL where your application is available in Runtime Manager. The URL has the format `APPLICATION_NAME.cloudhub.io` where your application resides in the cloudhub.io namespace. Ensure the application name has a green check mark for proper naming and being unique.
+
If you see the message: *You do not have permission to deploy new applications in this environment. Please select an existing application to redeploy*, click the environment button in the upper left of the Runtime Manager display to change environments from *Design* to *Production*.
+
. Set *Runtime Version* to Mule 3.8.5 or later, or to any 4.x version. Ensure that Runtime Manager shows the *Use Object Store v2* checkbox.
. Click the *Use Object Store v2* checkbox.
+
image::osv2-runtime-manager-deploy-app.png[osv2-runtime_manager_deploy_app]
+
. After configuring your application, click *Deploy Application*.
. In the Runtime Manager deploy window, wait until a message displays that your application successfully deployed to CloudHub.
. Click *Open in Browser and Close Window*.
. In Runtime Manager, click the right side of your application's entry to view its details.
. Click *Manage Application*. In the application's settings screen, note that Object Store appears in the left
side navigation area. The former label *Application Data* is now *Object Store for OSv2*.

== Send Data to the Object Store

From a command line prompt, use a utility to send JSON data to your Mule application. This can be a command such as curl, Postman, or a browser extension. Any serializable data can be sent to the
object store. The Object Store connector sends data as key/value pairs.

Example using curl:

----
curl -X POST -H "Content-Type: application/json" -d '{ "key": "TestKey01", "value": "This is an object store test" }' "http://APPLICATION_NAME.cloudhub.io/store"
----

Change `APPLICATION_NAME` to the name you chose when you deployed your application. Each time you submit this command, change the key's name so that each key is unique.

== View Data in the Object Store

To view data in the Object Store:

. Log into Anypoint Platform and click *Runtime Manager*.
. Click the name of your application to view the application's dashboard.
. Click *Object Store* from the left navigation bar:
+
image::osv2-in-nav-bar.png[]
+
The Object Store user interface:
+
image::osv2-ui.png[]
+
* The default object store name is `DEFAULT_USER_STORE`.
* The columns show the object store name, partition name, key, and key data. The partition groups object store keys.
+
. Click the object store name, partition name, and key to view each item's value.
. To delete a key, hover over a key name, and click the trash can icon. Similarly,
you can delete a partition or the store itself by hovering and clicking the trash
can icon.


== See Also

* xref:osv2-faq.adoc#how-long-can-data-persist-in-object-store-v2[How long can data persist in Object Store v2?]
* xref:connectors::object-store/object-store-connector.adoc[Object Store Connector - Mule 4]
* xref:release-notes::connector/object-store-connector-release-notes-mule-4.adoc[Object Store Connector Release Notes - Mule 4]
* xref:3.9@mule-runtime::object-store-connector.adoc[Object Store Connector - Mule 3]
* xref:release-notes::object-store/objectstore-release-notes.adoc[Object Store Connector Release Notes - Mule 3]
